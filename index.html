<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
                           integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
                           crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
            integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
            crossorigin=""></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      :root {
        --sidebar-width: 20%;
      }

      .builder {
        align-items: Stretch;
        display: flex;
        min-height: 100vh;
        min-width: 100%;
        max-width: 100%;
        margin: 0;
      }

      .builder__map {
        flex-grow: 1;
        flex-shrink: 0;
        width: calc(100% - (var(--sidebar-width) * 2));
      }

      .builder__sidebar {
        flex-grow: 0;
        flex-shrink: 0;
        width: var(--sidebar-width);
        max-height: 100vh;
        overflow: auto;
      }
    </style>
  </head>
  <body class="builder">
    <aside id="adder" class="builder__sidebar"></aside>
    <section id="map" class="builder__map" >
    </section>
      <aside class="builder__sidebar"></aside>

      <script>
var MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoicGFibG9yYyIsImEiOiJjajI3djNyOXAwMGR3MndzMWV2cjJicHo3In0.EIxpAD7wO3gmdkqt4ozKbg';
var GEOJSON_URL = 'https://xavijam.carto.com/api/v2/sql?q=SELECT%20*%20FROM%20ne_10m_populated_places_simple&format=GeoJSON';
var MAP_DOM_ID = 'map';


var Map = function() {
  this.layers = [];
};

Map.prototype.render = function(domID) {
  this.map = L.map(domID).setView([5,0], 2);
  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      id: 'mapbox.light',
      accessToken: MAPBOX_ACCESS_TOKEN
      }).addTo(this.map);
};

Map.prototype.addLayer = function(point) {
  L.geoJSON(point.toGeoJSON()).addTo(this.map);
};

var Point = function(attrs) {
  this.attrs = attrs;
  this.isShown = false;
};

Point.prototype.toGeoJSON = function() {
  return this.attrs;
}

var Points = function(points) {
  this.points = points;
}

Points.prototype.map = function(cb) {
  return this.points.map(cb);
};

Points.prototype.toGeoJSON = function() {
  return {
    type: 'FeatureCollection',
    features: this.points.map((point) => point.toGeoJSON())
  }
}

Points.prototype.slice = function(start, end) {
  return new Points(this.points.slice(start, end));
};

var PointView = function(point, onToggleCallback) {
  this.point = point;
  this.onToggleCallback = onToggleCallback;
}

PointView.prototype.render = function() {
  var isShown = this.point.isShown ? ':)' : ':('
  var li = document.createElement('li');
  var textNode = document.createTextNode(isShown + " " + this.point.attrs.properties.name);
  li.appendChild(textNode);
  li.addEventListener('click', () => this.onToggleCallback(this.point));
  return li;
}

var PointsView = function(points) {
  this.points = points;
}

PointsView.prototype.render = function(domId, onToggleCallback) {
  var renderedPoints = this.points.map((point) => new PointView(point, onToggleCallback).render());
  var append = (child) => document.getElementById(domId).appendChild(child);
  renderedPoints.map((child) => append(child));
}

self.fetch(GEOJSON_URL)
  .then((response) => {
    response.json()
      .then((geojson) => {
        var pointLibrary = new Points(geojson.features.map((point) => new Point(point)));
        var points = pointLibrary.slice(1,30);
        var map = new Map(points)
        map.render(MAP_DOM_ID);
        var onToggleCallback = function(pointSelected) {
          map.addLayer(new Points([this.point]));
        };
        new PointsView(pointLibrary).render('adder', onToggleCallback);
      });
  });
      </script>
  </body>
</html>

